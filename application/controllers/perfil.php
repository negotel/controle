<?phpif (!defined('BASEPATH'))    exit('No direct script access allowed');class Perfil extends CI_Controller {    function __construct() {        parent::__construct();        if ((!$this->session->userdata('session_id')) || (!$this->session->userdata('logado'))) {            redirect('dashboard/login');        }        $this->load->library('encrypt');        $this->load->library('form_validation');        $this->load->helper(array('form', 'codegen_helper'));        $this->data['title'] = 'Home';        $this->load->model('all_model', '', TRUE);        $this->load->model('permissoes_model', '', TRUE);        $this->data['dadosUsuario'] = $this->all_model->obterID('user', 'user_perfil', 'user_perfil.id_user = user.idUser', 'idUser', $this->session->userdata('idUser'));        $this->data['config'] = $this->all_model->obterID('config_sistema', '', '', 'idConfig', '1');        $this->data['imagensCapa'] = $this->all_model->obterImagensCapa('imagens', '6');    }    public function index() {        $this->data['menuPerfil'] = 'Meu Perfil';        $this->data['view'] = 'perfil/perfil';        $this->load->view('tema/home', $this->data);    }    public function editarPerfil() {                    $id = $this->input->post('idUsuarios');            //essa funçao e para verifica caso o administrator tente desativa ele mesmo            $dataNasc = $this->input->post('dataNasc');            try {                $dataNasc = explode('/', $dataNasc);                $dataNasc = $dataNasc[2] . '-' . $dataNasc[1] . '-' . $dataNasc[0];            } catch (Exception $e) {                $dataNasc = date('Y/m/d');            }            $data = array(                'nome_user' => $this->input->post('nome_user'),                'rg_user' => $this->input->post('rg_user'),                'cpf_user' => $this->input->post('cpf_user'),                'cep_user' => $this->input->post('cep_user'),                'rua_user' => $this->input->post('rua_user'),                'numero_user' => $this->input->post('numero_user'),                'bairro_user' => $this->input->post('bairro_user'),                'cidade_user' => $this->input->post('cidade_user'),                'uf_user' => $this->input->post('uf_user'),                'pais_user' => $this->input->post('pais_user'),                'celular_user' => $this->input->post('celular_user'),                'facebook_user' => $this->input->post('facebook_user'),                'twitter_user' => $this->input->post('twitter_user'),                'skype_user' => $this->input->post('skype_user'),                'profissao_user' => $this->input->post('profissao_user'),                'data_nasc_user' => $dataNasc,                'resumo_user' => $this->input->post('resumo_user'),                'estadoCivil_user' => $this->input->post('estadoCivil_user'),                'genero_user' => $this->input->post('genero_user')            );            if ($this->all_model->editarDados('user_perfil', $data, 'id_user', $this->input->post('idUser')) == TRUE) {                $this->session->set_flashdata('success', 'Conta alterada com sucesso!');                redirect(base_url('perfil'));            } else {                $this->data['custom_error'] = '<div class="form_error"><p>Ocorreu um erro.</p></div>';            }                    }        public function editarFoto(){        if((!$this->session->userdata('session_id')) || (!$this->session->userdata('logado'))){            redirect('login');        }        $id = $this->session->userdata('idUser');        if($id == null || !is_numeric($id)){            $this->session->set_flashdata('error','Ocorreu um erro ao tentar alterar a foto.');            redirect(base_url('perfil'));         }        $this->load->helper('file');        $image = $this->do_upload();        //$logo = base_url().'assets/img/demo/profile-pics/'.$image;	$data = array(	    'foto_user' => $image	);	if ($this->all_model->editarDados('user_perfil', $data, 'id_user', $this->session->userdata('idUser')) == TRUE) {            $this->session->set_flashdata('success', 'Sua foto foi alterada!');            redirect(base_url() . 'perfil');        } else {            $this->data['custom_error'] = '<div class="form_error"><p>Ocorreu um erro</p></div>';        }    }    function do_upload(){        if((!$this->session->userdata('session_id')) || (!$this->session->userdata('logado'))){            redirect('login');        }        $this->load->library('upload');        $image_upload_folder = FCPATH . 'assets/img/avatar';        if (!file_exists($image_upload_folder)) {            mkdir($image_upload_folder, DIR_WRITE_MODE, true);        }        $this->upload_config = array(            'upload_path'   => $image_upload_folder,            'allowed_types' => 'png|jpg|jpeg|bmp',            'max_size'      => 2048,	    'width'	    =>	320,            'height'    =>  240,            'remove_space'  => TRUE,            'encrypt_name'  => TRUE        );        $this->upload->initialize($this->upload_config);        if (!$this->upload->do_upload()) {            $upload_error = $this->upload->display_errors();            print_r($upload_error);            exit();        } else {            $file_info = array($this->upload->data());            return $file_info[0]['file_name'];        }    }        function alterarCapa(){                $data = array(            'foto_capa_user' => $this->input->post('capa')	);        if ($this->all_model->editarDados('user_perfil', $data, 'id_user', $this->session->userdata('idUser')) == TRUE) {            $this->session->set_flashdata('success', 'Capa Alterada com sucesso!');            redirect(base_url('perfil'));        } else {            $this->data['custom_error'] = '<div class="form_error"><p>Ocorreu um erro</p></div>';        }    }        public function alterarSenha() {                $oldSenha = $this->encrypt->sha1($this->input->post('oldSenha'));        $coldSenha = $this->input->post('coldSenha');        $newsenha  = $this->encrypt->sha1($this->input->post('newSenha'));;                if($oldSenha == $coldSenha){            if($oldSenha == $newsenha){                echo json_encode(array('result' => true, 'mensagen' => 'A nova senha não pode ser igual antiga.'));            }else{                $data = array(                'senha_user' => $newsenha                );                if ($this->all_model->editarDados('user', $data, 'idUser', $this->session->userdata('idUser')) == TRUE) {                    echo json_encode(array('result' => true, 'mensagen' => 'Senha Alterada com sucesso'));                } else {                    echo json_encode(array('result' => false, 'mensagen' => 'Ops, houve um error!'));                }            }        }else{            echo json_encode(array('result' => true, 'mensagen' => 'A senha atual não coresponde com a senha digita'));        }            }    public function excluir() {        $id = $this->input->post('id');        if ($this->all_model->delete('usuarios', 'idUsuarios', $id) == TRUE) {            $this->session->set_flashdata('success', 'Conta excluida com sucesso!');            redirect(base_url() . 'usuarios');        } else {            $this->session->set_flashdata('error', ' Ops! algo deu errado');            redirect(base_url() . 'usuarios');        }    }}